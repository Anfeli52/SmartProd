<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" th:href="@{/css/dashboard.css}">
    <link rel="stylesheet" th:href="@{/css/registros.css}">
    <link href='https://cdn.boxicons.com/fonts/basic/boxicons.min.css' rel='stylesheet'>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <title>Dashboard</title>
</head>
<body>
    <div th:replace="~{analista/fragment_analista :: menu}"></div>
    <section th:replace="~{analista/fragment_analista :: sidebar(~{::content})}">

        <div class="home-content" th:fragment="content">
            <h1>Listado de Registros de Ítems</h1>
            <p>Datos obtenidos de la base de datos.</p>

            <div class="add-button">
                <a th:href="@{/analista/registros/nuevo}" class="btn">Agregar Ítem</a>
            </div>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>ID Item</th>
                        <th>Nombre</th>
                        <th>Cant. Pintura</th>
                        <th>Lavado</th>
                        <th>Pintura</th>
                        <th>Horneo</th>
                        <th>Estado</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="item : ${items}">
                        <td th:text="${item.numeroItem}"></td>
                        <td th:text="${item.nombre}"></td>
                        <td th:text="${item.cantidadPintura}"></td>
                        <td th:text="${item.lavado}"></td>
                        <td th:text="${item.pintura}"></td>
                        <td th:text="${item.horneo}"></td>
                        <td th:text="${item.estado}"></td>
                        <td class="action-buttons">

                            <button type="button" class="btn-calc"
                                    data-bs-toggle="modal" data-bs-target="#calculationModal"
                                    th:onclick="|openCalculationModal('${item.numeroItem}')|">
                                Calcular
                            </button>

                            <a th:href="@{/analista/items/edit/{id}(id=${item.numeroItem})}" class="btn-edit">Editar</a>
                            <button class="btn-delete" th:onclick="|confirmDeleteItem('${item.numeroItem}')|">Eliminar</button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </section>
    <div class="modal fade" id="calculationModal" tabindex="-1" aria-labelledby="calculationModalLabel" aria-hidden="true">

        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="calculationModalLabel">Cálculo de Producción para Ítem: <span id="modalItemNumber"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <form id="calculationForm">
                    <div class="modal-body">
                        <input type="hidden" id="itemId" name="itemId" value="">

                        <div class="mb-3">
                            <label for="inputPieces" class="form-label">Cantidad de Piezas a Producir:</label>
                            <input type="number" class="form-control" id="inputPieces" name="pieces" min="1" required>
                        </div>

                        <div id="calculationResult" class="mt-3 alert" style="display:none;">
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                        <button type="submit" class="btn btn-primary">Calcular Costo Total</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>

        document.getElementById('calculationForm').addEventListener('submit', function(event) {
            event.preventDefault();

            const itemId = document.getElementById('itemId').value;
            const pieces = document.getElementById('inputPieces').value;
            const resultDiv = document.getElementById('calculationResult');

            // Preparar los datos para enviar al controlador de Spring (como x-www-form-urlencoded)
            const formData = new URLSearchParams();
            formData.append('itemId', itemId);
            formData.append('pieces', pieces);

            // Llama al endpoint de Java que creaste: /api/analista/items/calculate
            fetch('/api/analista/items/calculate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: formData
            })
                .then(response => {
                    if (!response.ok) {
                        // Si el servidor retorna un error (4xx o 5xx)
                        return response.json().then(err => { throw new Error(err.message || response.statusText); });
                    }
                    return response.json(); // Parsea el JSON a un objeto JS
                })
                .then(data => {
                    // Éxito: 'data' es el objeto CalculationResult de Java
                    let htmlResult = `
                    <p><strong>Resultado para ${data.pieces} piezas:</strong></p>
                    <ul>
                        <li>Total Pintura: <strong>${data.totalPintura.toFixed(3)}</strong></li>
                        <li>Total Lavado (min): <strong>${data.totalLavado.toFixed(3)}</strong></li>
                        <li>Total Pintura (min): <strong>${data.totalPinturaMin.toFixed(3)}</strong></li>
                        <li>Total Horneo (min): <strong>${data.totalHorneo.toFixed(3)}</strong></li>
                    </ul>
                `;

                    resultDiv.className = 'mt-3 alert alert-success';
                    resultDiv.innerHTML = htmlResult;
                    resultDiv.style.display = 'block';
                })
                .catch(error => {
                    // Manejar errores
                    console.error('Error de cálculo:', error);
                    resultDiv.className = 'mt-3 alert alert-danger';
                    resultDiv.innerHTML = 'Error al realizar el cálculo: ' + (error.message || 'Error desconocido.');
                    resultDiv.style.display = 'block';
                });
        });
    </script>

    <script th:src="@{/js/script.js}"></script>



</body>
</html>
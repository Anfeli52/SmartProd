<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" th:href="@{/css/dashboard.css}">
    <link rel="stylesheet" th:href="@{/css/dashboard_supervisor.css}">
    <link href='https://cdn.boxicons.com/fonts/basic/boxicons.min.css' rel='stylesheet'>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <title>Dashboard Supervisor</title>
</head>
<body>
    <div th:replace="~{supervisor/fragment_supervisor :: menu}"></div>
    <section th:replace="~{supervisor/fragment_supervisor :: sidebar(~{::content})}">
        <div class="home-content" th:fragment="content">
            <div class="overview-boxes">
                <div class="box">
                    <div class="right-side">
                        <div class="box-topic">Ítems en Producción</div>
                        <div class="number" th:text="${itemsEnProduccion}">0</div>
                        <div class="indicator">
                            <i class='bxr bx-arrow-up-stroke' th:classappend="${tasaDesperdicio > 5 ? 'down' : ''}"></i>
                            <span class="text">Procesando ahora</span>
                        </div>
                    </div>
                    <i class='bxr bx-factory factory'></i>
                </div>
                <div class="box">
                    <div class="right-side">
                        <div class="box-topic">Tasa de Desperdicio</div>
                        <div class="number" th:text="${tasaDesperdicio} + '%'">0%</div>
                        <div class="indicator">
                            <i class='bxr bx-arrow-up-stroke' th:classappend="${tasaDesperdicio > 5 ? 'down' : ''}"></i>
                            <span class="text" th:text="${tasaDesperdicio > 5 ? '¡Alerta!' : 'Meta Cumplida'}"></span>
                        </div>
                    </div>
                    <i class='bxr bx-trash-x trash'></i>
                </div>
                <div class="box">
                    <div class="right-side">
                        <div class="box-topic">Total de Usuarios</div>
                        <div class="number" th:text="${totalUsuarios}">0</div>
                        <div class="indicator">
                            <i class='bxr bx-user-plus'></i>
                            <span class="text">Supervisores + Analistas</span>
                        </div>
                    </div>
                    <i class='bxr bx-user-circle user-icon'></i>
                </div>
                <div class="box">
                    <div class="right-side">
                        <div class="box-topic">Retraso Promedio</div>
                        <div class="number" th:text="${retrasoPromedio} + ' min'">0 min</div>
                        <div class="indicator">
                            <i class='bxr bx-arrow-down-stroke' th:classappend="${retrasoPromedio > 10 ? 'down' : ''}"></i>
                            <span class="text" th:text="${retrasoPromedio > 10 ? 'Necesita Atención' : 'A tiempo'}"></span>
                        </div>
                    </div>
                    <i class='bxr bx-timer timer'></i>
                </div>
            </div>
            <div class="charts-container">
                <div class="chart-box">
                    <canvas id="produccionActividadChart"></canvas>
                </div>
                <div class="chart-box">
                    <canvas id="calidadChart"></canvas>
                </div>
            </div>
        </div>
    </section>

    <script th:src="@{/js/script.js}"></script>
    <script th:inline="javascript">

        // DATOS PARA EL GRÁFICO DE BARRAS: Ítems más usados (Nueva variable)
        const itemsMasUsados = /*[[${itemsMasUsados}]]*/ [];
        const labelsItems = itemsMasUsados.map(item => item[0]);
        const valuesItems = itemsMasUsados.map(item => item[1]);

        const ctxBarras = document.getElementById('produccionActividadChart');
        new Chart(ctxBarras, {
            type: 'bar',
            data: {
                // Usando las nuevas variables
                labels: labelsItems,
                datasets: [{
                    label: 'Cantidad de Veces Registrado',
                    // Usando las nuevas variables
                    data: valuesItems,
                    backgroundColor: 'rgba(54, 162, 235, 0.8)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        // Nuevo Título
                        text: 'Top 5 Ítems Más Utilizados en Producción'
                    },
                    legend: { display: false }
                },
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });


        const dataCalidad = /*[[${calidadTotal}]]*/ [];
        const conforme = dataCalidad[0] ?? 0;
        const noConforme = dataCalidad[1] ?? 0;

        const ctxDona = document.getElementById('calidadChart');
        new Chart(ctxDona, {
            type: 'doughnut',
            data: {
                labels: ['Conforme', 'No Conforme'],
                datasets: [{
                    label: 'Unidades',
                    data: [conforme, noConforme],
                    backgroundColor: [
                        'rgba(75, 192, 192, 0.8)',
                        'rgba(255, 99, 132, 0.8)'
                    ],
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Proporción de Calidad Total'
                    }
                }
            }
        });

    </script>
</body>
</html>